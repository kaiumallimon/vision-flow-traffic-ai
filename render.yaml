# ══════════════════════════════════════════════════════════════════
#  Render Deployment Configuration — Vision Flow Backend (FastAPI)
#  Docs: https://render.com/docs/render-yaml-spec
# ══════════════════════════════════════════════════════════════════

services:
  - type: web
    name: visionflow-backend
    runtime: python
    region: oregon           # choose closest to your users
    plan: free               # free tier (spins down after 15 min inactivity)

    buildCommand: |
      pip install --upgrade pip
      pip install -r fastapi_requirements.txt
      prisma generate --schema=schema.prisma
      prisma py fetch
      find /opt/render -name "prisma-query-engine-debian-openssl-3.0.x" -exec cp {} /opt/render/project/src/ \;
      prisma db push --accept-data-loss --schema=schema.prisma

    startCommand: uvicorn app.main:app --host 0.0.0.0 --port $PORT

    # Health check — Better Stack / UptimeRobot should ping this URL
    # to keep the free instance alive
    healthCheckPath: /health

    envVars:
      # ── Database (Neon) ─────────────────────────────────────────
      - key: DATABASE_URL
        value: postgresql://neondb_owner:npg_oKwnbuMOG24f@ep-plain-wildflower-aig01o4t-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require

      # ── Auth ───────────────────────────────────────────────────
      - key: SECRET_KEY
        sync: false

      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: "30"

      # ── Frontend origin (CORS) ─────────────────────────────────
      - key: FRONTEND_URL
        sync: false          # e.g. https://your-app.vercel.app

      # ── YOLO Model (bundled in repo) ───────────────────────────
      - key: YOLO_MODEL_PATH
        value: "yolo11n_openvino_model/"

      # ── Cloudinary (media storage) ─────────────────────────────
      - key: CLOUDINARY_CLOUD_NAME
        sync: false
      - key: CLOUDINARY_API_KEY
        sync: false
      - key: CLOUDINARY_API_SECRET
        sync: false

      # ── Email ──────────────────────────────────────────────────
      - key: EMAIL_HOST
        value: "smtp.gmail.com"
      - key: EMAIL_PORT
        value: "465"
      - key: EMAIL_HOST_USER
        sync: false
      - key: EMAIL_HOST_PASSWORD
        sync: false
      - key: DEFAULT_FROM_EMAIL
        sync: false

      # ── OpenRouter ─────────────────────────────────────────────
      - key: OPENROUTER_API_KEY
        sync: false

      # ── Admin ──────────────────────────────────────────────────
      - key: ADMIN_EMAILS
        sync: false
